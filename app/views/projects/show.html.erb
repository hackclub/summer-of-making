<div data-controller="image-viewer">
  <div data-image-viewer-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75" data-action="click->image-viewer#closeBackground">
    <div class="relative max-w-7xl max-h-[90vh] w-full flex items-center justify-center">
      <button class="absolute top-2 right-2 md:top-4 md:right-4 text-white p-2 hover:scale-110 transition-transform z-10" data-action="image-viewer#close">
        <%= inline_svg "close.svg", class: "h-6 w-6 md:h-8 md:w-8" %>
      </button>
      <img data-image-viewer-target="image" class="max-h-[85vh] max-w-full object-contain" src="" alt="Full size image">
    </div>
  </div>

  <div class="container mx-auto px-4 py-4 md:py-8 max-w-4xl">
    <%= render "projects/project_card" %>

    <% if user_signed_in? && current_user == @project.user %>
      <div id="devlog-form" class="mb-4 md:mb-6">
        <%= render "devlogs/devlog_form" %>
      </div>
    <% end %>

    <% if @timeline.present? %>
      <div class="flex flex-col justify-between items-start mb-2 md:mb-6">
        <h2 class="text-3xl md:text-5xl">Timeline</h2>
      </div>
    <% end %>

    <div class="relative">
      <% unless @timeline.present? %>
        <div class="absolute left-3 md:left-8 top-0 bottom-0 w-0.5 border-l-2 border-dashed border-saddle-taupe/30"></div>
      <% end %>

      <div id="devlogs" class="space-y-3 md:space-y-8 ml-6 md:ml-16">
        <% unless !@timeline.present? %>
          <div class="border-5 border-[#E4DCC6] absolute left-6 md:left-[67.2] bottom-11 -top-4 rounded-xl"></div>
        <% end %>

        <% @timeline.each do |item| %>
            <div class="flex align-center justify-center">
            <%= image_tag "timeline-stalk.svg", width: 56, class: "-mr-2 -mt-11" %>

            <div class="grow-1">
            <% if item.is_a? Devlog %>
                <%= render "devlogs/devlog", devlog: item %>
            <% elsif item.is_a? ShipEvent %>
              <div class="w-full border-5 border-[#E4DCC6] bg-[#F3ECD8] p-2 rounded-xl">

                  <% p = @ship_events.where("created_at < ?", item.created_at).order(:created_at) %>
                  <% position = p.count + 1 %>
                  <p class="font-medium text-base sm:text-lg 2xl:text-xl mb-2 sm:mb-3">Ship <%= position %></p>

                  <% payout_count = Payout.where(payable: item).count %>
                  <p><%= pluralize(payout_count, "payout") %> totaling $<%= Payout.where(payable: item).sum(&:amount) %></p>

                  <div class="flex items-center">
                    <% if item.user.avatar.present? %>
                      <img src="<%= item.user.avatar %>" alt="<%= item.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
                    <% end %>
                    <div>
                        <p class="text-gray-600 text-xs sm:text-sm 2xl:text-base"><%= time_ago_in_words item.created_at %> ago</p>

                      <span class="font-medium text-base sm:text-lg 2xl:text-xl"><%= item.user.display_name %></span>

                      <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base">â€¢</span>

                      <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base">Covers <%= pluralize(item.devlogs_since_last.count, "devlog") %></span>

                      <%
                        # Get devlogs since previous ship event or project start
                        # previous_ship = p.last
                        # start_time = previous_ship&.created_at || @project.created_at
                        # devlogs_in_period = @project.devlogs.where("created_at > ? AND created_at <= ?", start_time, item.created_at)

                        # # Get hackatime data for this period (simplified - getting project total)
                        # time = @project.hackatime_total_time / 3600.0

                        # devlog_count = devlogs_in_period.count

                        # hours = time.to_i
                        # minutes = ((time - hours) * 60).to_i
                        #  class="text-gray-600 text-xs sm:text-sm 2xl:text-base">contains <%= pluralize(devlog_count, 'devlog')  across <hours h minutes mins of coding.
                      %>

                    </div>
                  </div>
              </div>
            <% end %>
            </div>
            </div>
        <% end %>

        <!-- <%# if @devlogs.empty? && current_user != @project.user %>
          <div class="bg-[#F3ECD8] rounded-2xl border-4 border-[#E4DCC6] p-6 md:p-12 text-center ml-6 md:ml-16">
            <h2 class="text-xl md:text-2xl 2xl:text-3xl mb-3 md:mb-4">No Devlogs yet</h2>
            <div class="flex justify-center items-center">
              <%# image_tag 'puppyeyes.png', class: 'w-16 h-16 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 transform scale-x-[-1] mb-4 sm:mb-6' %>
            </div>
          </div>
        <%# end %>

        <%# if @devlogs.empty? && ENV['DEVLOGS_STATUS'] != 'locked' && current_user == @project.user %>
          <div class="bg-[#F3ECD8] rounded-2xl border-4 border-[#E4DCC6] p-6 md:p-12 text-center ml-6 md:ml-16">
            <h2 class="text-xl md:text-2xl 2xl:text-3xl mb-3 md:mb-4">No devlogs yet</h2>
            <div class="flex justify-center items-center">
              <%# image_tag 'puppyeyes.png', class: 'w-16 h-16 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 transform scale-x-[-1] mb-4 sm:mb-6' %>
            </div>
            <p class="text-sm md:text-base 2xl:text-lg text-gray-600">Post a devlog!</p>
          </div>
        <%# end %> -->
      </div>
    </div>

  </div>
</div>

<div class="hidden">
  <div id="valid-check-icon" class="inline-block">
    <%= inline_svg "check.svg", class: "h-4 w-4 text-forest inline" %>
  </div>
</div>

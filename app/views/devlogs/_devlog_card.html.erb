<%
  # Default parameter values
  context ||= 'default'                    # 'explore', 'project', 'activity', 'stonk'
  show_project_title ||= false             # Whether to show project title
  show_project_navigation ||= false        # Whether the card should navigate to project
  show_likes ||= false                     # Whether to show like button
  show_comment_modal ||= false             # Whether to show comment button/icon (w/ number of comments)
  show_comments_inline ||= false           # Whether to show comments inline
  show_stonks ||= false                    # Whether to show stonks count
  container_classes ||= ''                 # Additional container classes
  content_margin ||= ''                    # Content margin/padding classes
%>

<%= render layout: "shared/container" do %>

<div class="ml-4 <%= context == 'explore' || context == 'project' ? '' : '' %> <%= container_classes %> <%= 'cursor-pointer' if show_project_navigation %>"
     id="<%= dom_id(devlog) %>"
     data-controller="modal devlog-card"
     data-devlog-card-project-path-value="<%= project_path(devlog.project) if show_project_navigation %>"
     data-devlog-card-show-project-navigation-value="<%= show_project_navigation %>"
     data-devlog-card-max-length-value="200"
     data-action="<%= 'click->devlog-card#navigateToProject' if show_project_navigation %>">

  <div class="flex items-center justify-between mb-2 sm:mb-3">
    <div class="flex items-center">
      <% if devlog.user.avatar.present? %>
        <img src="<%= devlog.user.avatar %>" alt="<%= devlog.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
      <% end %>
      <div>
        <span class="text-base sm:text-lg 2xl:text-xl">@<%= devlog.user.display_name %></span>

        <div class="text-[#B89576]">
          <!-- Time info -->
          <% if devlog.timer_sessions.any? %>
            <% timer_session = devlog.timer_sessions.first %>
            <span>
              <% hours = timer_session.net_time / 3600 %>
              <% minutes = (timer_session.net_time % 3600) / 60 %>
              <%= hours > 0 ? "#{hours}h spent working" : "#{minutes}m spent working" %>
            </span>
            <span class=""> • </span>
          <% elsif devlog.last_hackatime_time.present? && devlog.last_hackatime_time > 0 %>
            <span>
              <% hours = devlog.last_hackatime_time / 3600 %>
              <% minutes = (devlog.last_hackatime_time % 3600) / 60 %>
              <%= hours > 0 ? "#{hours}h spent working" : "#{minutes}m spent working" %>
            </span>
            <span> • </span>
          <% end %>

          <!-- Time ago -->
          <span>
            <% time_diff = Time.current - devlog.created_at %>
            <% if time_diff >= 86400 %>
              <% days = (time_diff / 86400).to_i %>
              <%= "#{days}d ago" %>
            <% elsif time_diff >= 3600 %>
              <% hours = (time_diff / 3600).to_i %>
              <%= "#{hours}h ago" %>
            <% elsif time_diff >= 60 %>
              <% minutes = (time_diff / 60).to_i %>
              <%= "#{minutes}m ago" %>
            <% else %>
              <% seconds = time_diff.to_i %>
              <%= "#{seconds}s ago" %>
            <% end %>
          </span>

          <% if show_stonks && devlog.project.stonks.count %>
          <span>
          • <%= pluralize(devlog.project.stonks.count, 'stonker') %>
          </span>
          <% end %>

          <span> • </span>
          <% position = devlog.project.devlogs.where("created_at < ?", devlog.created_at).count + 1 %>
          <span><%= position.ordinalize %> devlog</span>
        </div>
      </div>
    </div>
  </div>

  <div class="<%= content_margin.present? ? content_margin : '' %> max-w-4xl">
    <!-- Update content -->
    <div data-devlog-card-target="content" class="prose max-w-[32em] text-black mb-2 sm:mb-3 text-base sm:text-lg 2xl:text-xl break-words overflow-wrap-anywhere">
      <%= devlog.formatted_text %>
    </div>

    <!-- Attachments -->
    <% if devlog.attachment.present? %>
      <div class="mt-2 sm:mt-3">
        <% attachment_url = devlog.attachment %>
        <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
        <% if clean_url.match?(/\.(jpg|jpeg|png|gif|heic|heif|webp)$/i) %>
          <img src="<%= attachment_url %>" alt="Update attachment" class="w-full object-contain cursor-pointer hover:opacity-90 transition-opacity rounded-lg" data-action="click->image-viewer#open">
        <% elsif clean_url.match?(/\.(mp4|webm|mov)$/i) %>
          <div class="w-full flex items-center justify-center bg-black rounded-lg">
            <video src="<%= attachment_url %>" class="w-full object-contain rounded-lg" playsinline controls>
              Your browser does not support the video tag.
            </video>
          </div>
        <% elsif devlog.attachment.match?(/\.(mp3|wav|m4a|ogg|flac)$/i) %>
          <div class="w-full flex items-center justify-center py-4">
            <audio src="<%= devlog.attachment %>" class="w-full max-w-md" controls controlsList="nodownload">
              Your browser does not support the audio tag.
            </audio>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Action buttons -->
    <div class="mt-3 sm:mt-4 flex items-center justify-start gap-x-4 max-w-prose">
      <!-- Like button -->
      <% if show_likes && user_signed_in? %>
        <%= render "likes/button", likeable: devlog %>
      <% end %>

      <!-- Comment button -->
      <% if show_comment_modal && user_signed_in? %>
        <%= render "comments/button", devlog: devlog %>
      <% end %>

      <!-- More button -->
      <% if user_signed_in? && current_user == devlog.user %>
      <div class="relative" data-controller="dropdown">
        <button data-action="click->dropdown#toggle" class="text-gray-600 hover:text-nice-blue transition-colors duration-200 p-2">
          <%= inline_svg_tag "more.svg", class: "w-5 h-5 sm:w-6 sm:h-6" %>
        </button>
        <div data-dropdown-target="menu" class="absolute right-0 top-full mt-1 w-32 bg-[#F3ECD8] rounded-2xl border-4 border-[#E4DCC6] shadow-lg py-1 z-50 hidden">
          <% unless defined?(@project) && @project&.is_shipped? %>
            <button data-action="click->modal#open" data-modal-id="<%= devlog.id %>" data-modal-type="edit" class="w-full px-4 py-2 text-left text-sm text-nice-blue hover:text-nice-blue transition-colors duration-200">
              Edit
            </button>
            <%= button_to "Delete", project_devlog_path(devlog.project, devlog),
                method: :delete,
                class: "w-full px-4 py-2 text-left text-sm text-vintage-red hover:bg-saddle-taupe/10 transition-colors duration-200",
                data: { controller: "delete-confirmation", action: "click->delete-confirmation#confirm" } %>
          <% end %>
        </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Inline comments -->
  <% if show_comments_inline %>
    <div id="comments-<%= devlog.id %>" class="mt-4 ml-4 sm:ml-6 space-y-3">
    <%= render devlog.comments %>
    </div>
  <% end %>
</div>

<!-- Render comment modal based on context -->
<% if show_comment_modal || context == 'project' %>
  <%= render "comments/modal", devlog: devlog %>
<% end %>

<!-- Edit Modal (only for project owner) -->
<% if user_signed_in? && current_user == devlog.user %>
    <%= render "devlogs/edit_modal", devlog: devlog %>
<% end %>

<% end %>

<body class="adash" style="background: var(--color-background); color: var(--color-text); min-height: 100vh; padding: 2rem;">

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
  <h1>Low-quality review
    <span class="pill pill-yellow" style="font-size: 0.6em; margin-left: 0.5rem;">
      <%= @threshold %>+ reports
    </span>
  </h1>
  <div style="display: flex; gap: 1rem;">
    <%= link_to "Ship Certifications", admin_ship_certifications_path, class: "pill pill-gray", style: "text-decoration: none; padding: 0.5rem 1rem;" %>
    <button id="toggle-analytics" class="pill pill-blue" style="padding: 0.5rem 1rem; border: none; cursor: pointer;">Show Analytics</button>
  </div>
</div>

<!-- Analytics Section -->
<div id="analytics-section" style="display: none; margin-bottom: 2rem;">
  <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
    <!-- Volume Metrics -->
    <div style="background: var(--color-card); padding: 1rem; border-radius: 8px; flex: 1;">
      <h3>Volume Trends</h3>
      <p><strong>Reports This Week:</strong>
        <span class="pill pill-dark"><%= @reports_current_week || 0 %></span>
        <% if (@wow_change || 0) != 0 %>
          <span style="font-size: 0.8em; color: <%= (@wow_change || 0) > 0 ? '#ff6b6b' : '#51cf66' %>;">
            <%= (@wow_change || 0) > 0 ? '↑' : '↓' %><%= (@wow_change || 0).abs %>%
          </span>
        <% end %>
      </p>
      <p><strong>Reports Last Week:</strong> <span class="pill pill-gray"><%= @reports_last_week || 0 %></span></p>
      <p><strong>Reports This Month:</strong>
        <span class="pill pill-dark"><%= @reports_current_month || 0 %></span>
        <% if (@mom_change || 0) != 0 %>
          <span style="font-size: 0.8em; color: <%= (@mom_change || 0) > 0 ? '#ff6b6b' : '#51cf66' %>;">
            <%= (@mom_change || 0) > 0 ? '↑' : '↓' %><%= (@mom_change || 0).abs %>%
          </span>
        <% end %>
      </p>
      <p><strong>Cases Needing Attention:</strong> <span class="pill pill-red"><%= @current_cases_needing_attention || 0 %></span></p>
      <p><strong>Total Unresolved Reports:</strong> <span class="pill pill-yellow"><%= @total_unresolved_reports || 0 %></span></p>
    </div>

    <!-- Resolution Metrics -->
    <div style="background: var(--color-card); padding: 1rem; border-radius: 8px; flex: 1;">
      <h3>Resolution Performance</h3>
      <p><strong>Resolved This Week:</strong> <span class="pill pill-green"><%= @resolved_current_week || 0 %></span></p>
      <p><strong>Resolved This Month:</strong> <span class="pill pill-green"><%= @resolved_current_month || 0 %></span></p>
      </p>
      <p><strong>Resolution Rate:</strong>
        <span style="font-weight: bold; color: <%= (@resolution_rate || 0) > 80 ? '#51cf66' : (@resolution_rate || 0) > 50 ? '#ffd43b' : '#ff6b6b' %>;">
          <%= @resolution_rate || 0 %>%
        </span>
      </p>
    </div>

    <!-- Impact Metrics -->
    <div style="background: var(--color-card); padding: 1rem; border-radius: 8px; flex: 1;">
      <h3>Impact & Actions</h3>
      <p><strong>Marked Low Quality:</strong> <span class="pill pill-red"><%= @marked_low_quality || 0 %></span></p>
      <p><strong>Marked OK:</strong> <span class="pill pill-green"><%= @marked_ok || 0 %></span></p>
      <p><strong>Total Payout Amount:</strong> <span style="font-weight: bold;"><%= @low_quality_payouts_total || 0 %> shells</span></p>
      <p><strong>Repeat Offenders:</strong> <span class="pill pill-red"><%= (@repeat_offenders_data || []).length %></span></p>
    </div>
  </div>

  <!-- Admin Performance -->
  <div style="background: var(--color-card); padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
    <h3>Shipwright's Performance (Last 30 days)</h3>
    <% if (@admin_resolution_counts || {}).any? %>
      <table style="width: 100%; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="text-align: left;">Admin</th>
            <th style="text-align: right;">Cases Resolved</th>
          </tr>
        </thead>
        <tbody>
          <% (@admin_resolution_counts || {}).each do |admin_name, count| %>
            <tr style="background: <%= cycle('#1c1b22', '#414142') %>;">
              <td><%= admin_name %></td>
              <td style="text-align: right;"><%= count %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No resolution data available.</p>
    <% end %>
  </div>

  <!-- Repeat Offenders -->
  <% if (@repeat_offenders_data || []).any? %>
    <div style="background: var(--color-card); padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
      <h3>Repeat Offenders (Multiple Reports This Month)</h3>
      <table style="width: 100%; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="text-align: left;">User</th>
            <th style="text-align: right;">Report Count</th>
          </tr>
        </thead>
        <tbody>
          <% (@repeat_offenders_data || []).each do |offender_data| %>
            <tr style="background: <%= cycle('#1c1b22', '#414142') %>;">
              <td>
                <%= offender_data[:display_name] %>
                <% if offender_data[:user] %>
                  <br><small style="color: var(--color-text-muted);"><%= offender_data[:user].email %></small>
                <% end %>
              </td>
              <td style="text-align: right;">
                <span class="pill pill-red"><%= offender_data[:report_count] %></span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <!-- Weekly Trend -->
  <div style="background: var(--color-card); padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
    <h3>8-Week Trend</h3>
    <% if (@weekly_data || []).any? %>
      <table style="width: 100%; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="text-align: left;">Week</th>
            <th style="text-align: right;">Reports</th>
            <th style="text-align: right;">Resolutions</th>
            <th style="text-align: right;">Net Change</th>
          </tr>
        </thead>
        <tbody>
          <% (@weekly_data || []).each do |week_data| %>
            <% net_change = week_data[:resolutions] - week_data[:reports] %>
            <tr style="background: <%= cycle('#1c1b22', '#414142') %>;">
              <td><%= week_data[:week] %></td>
              <td style="text-align: right;"><%= week_data[:reports] %></td>
              <td style="text-align: right;"><%= week_data[:resolutions] %></td>
              <td style="text-align: right; color: <%= net_change >= 0 ? '#51cf66' : '#ff6b6b' %>;">
                <%= net_change >= 0 ? '+' : '' %><%= net_change %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No trend data available.</p>
    <% end %>
  </div>
</div>

<div class="asec" style="padding: 1.5em;">
  <h2>Current Cases</h2>
  <p>Projects with <strong><%= @threshold %>+</strong> <%= @state %> reports.</p>

  <div style="margin: 12px 0; display: flex; gap: 8px;">
    <%= link_to admin_low_quality_dashboard_index_path(state: 'unresolved'), class: "pill #{ @state == 'unresolved' ? 'pill-yellow' : 'pill-gray' }", style: "text-decoration: none; padding: 0.5rem 1rem;" do %>
      Unresolved
    <% end %>
    <%= link_to admin_low_quality_dashboard_index_path(state: 'resolved'), class: "pill #{ @state == 'resolved' ? 'pill-green' : 'pill-gray' }", style: "text-decoration: none; padding: 0.5rem 1rem;" do %>
      Resolved
    <% end %>
  </div>

  <% if @projects.empty? %>
    <p>No projects need review.</p>
  <% else %>
    <table>
      <thead>
        <tr>
          <th>Project</th>
          <th>Reports</th>
          <th>Latest Ship</th>
          <th>Payouts</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @projects.each do |project| %>
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; overflow: hidden; border-radius: 0;">
                  <% if project.banner.attached? %>
                    <%= image_tag project.banner, style: "width: 100%; height: 100%; object-fit: cover;" %>
                  <% else %>
                    <div style="width: 100%; height: 100%; background: rgba(228, 220, 198, 0.15); display: flex; align-items: center; justify-content: center; color: #E4DCC6; font-size: 10px; text-transform: uppercase;">No image</div>
                  <% end %>
                </div>
                <div>
                  <div style="font-weight: 600; color: #ffffff;">
                    <%= link_to project.title, project, style: "color: var(--color-primary)" %>
                  </div>
                  <small style="color: #E4DCC6; opacity: 0.9;">by <%= project.user.display_name %></small>
                </div>
              </div>
            </td>
            <td>
              <strong style="color: #ffffff;"><%= @reported[project.id] %></strong>
              <% if @project_reports[project.id]&.any? %>
                <% preview_report = @project_reports[project.id].last %>
                <div style="margin-top: 8px; padding: 8px; background: rgba(228, 220, 198, 0.1); border-left: 2px solid #E4DCC6;">
                  <div style="font-size: 12px; color: #E4DCC6; margin-bottom: 4px;">
                    <%= preview_report.reporter&.display_name || "Unknown" %> • <%= preview_report.created_at.strftime('%b %d') %>
                    <% if preview_report.resolved? %>
                      • <span>resolved <%= time_ago_in_words(preview_report.resolved_at || Time.current) %> ago by <%= preview_report.resolver&.display_name || preview_report.resolver&.email || 'Unknown' %> (<%= preview_report.resolved_outcome == 'low_quality' ? 'Marked low-quality' : (preview_report.resolved_outcome == 'ok' ? 'Marked OK' : 'Resolved') %>)</span>
                    <% end %>
                  </div>
                  <div style="color: #ffffff; font-size: 14px;">
                    <%= preview_report.reason&.gsub(/^LOW_QUALITY:\s*/, '') || preview_report.reason %>
                    <% if preview_report.resolved? && preview_report.resolved_message.present? %>
                      <div style="margin-top: 6px; font-size: 12px; color: #E4DCC6;">Justification: <%= preview_report.resolved_message %></div>
                    <% end %>
                  </div>
                </div>
                <details style="margin-top: 8px;">
                  <summary style="color: #E4DCC6; cursor: pointer; font-size: 12px;">View all reasons</summary>
                  <div style="margin-top: 8px; padding: 8px; background: rgba(228, 220, 198, 0.1); border-left: 2px solid #E4DCC6;">
                    <% @project_reports[project.id].each do |report| %>
                      <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(228, 220, 198, 0.2);">
                        <div style="font-size: 12px; color: #E4DCC6; margin-bottom: 4px;">
                          <%= report.reporter&.display_name || "Unknown" %> • <%= report.created_at.strftime('%b %d') %>
                          <% if report.resolved? %>
                            • <span>resolved <%= time_ago_in_words(report.resolved_at || Time.current) %> ago by <%= report.resolver&.display_name || report.resolver&.email || 'Unknown' %> (<%= report.resolved_outcome == 'low_quality' ? 'Marked low-quality' : (report.resolved_outcome == 'ok' ? 'Marked OK' : 'Resolved') %>)</span>
                          <% end %>
                        </div>
                        <div style="color: #ffffff; font-size: 14px;">
                          <%= report.reason&.gsub(/^LOW_QUALITY:\s*/, '') || report.reason %>
                          <% if report.resolved? && report.resolved_message.present? %>
                            <div style="margin-top: 6px; font-size: 12px; color: #E4DCC6;">Justification: <%= report.resolved_message %></div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </details>
              <% end %>
            </td>
            <td>
              <% last_ship = @latest_ship_by_project[project.id] || project.ship_events.order(:created_at).last %>
              <span style="color: #ffffff;"><%= last_ship&.created_at&.strftime('%b %d') || '—' %></span>
            </td>
            <td>
              <span style="color: #ffffff;"><%= (@latest_ship_has_payout && @latest_ship_has_payout[project.id]) ? 'yes' : 'no' %></span>
            </td>
            <td>
              <% if @state != 'resolved' %>
                <div style="display: flex; gap: 12px;">
                  <details style="margin-right: 8px;">
                    <summary style="color: #E4DCC6; cursor: pointer; font-size: 13px; background: #e74c3c; color: white; padding: 10px 14px; border-radius: 0;">Mark low-quality</summary>
                    <div style="margin-top: 8px; padding: 12px; background: rgba(231, 76, 60, 0.1); border: 2px solid #e74c3c; border-radius: 0;">
                      <%= form_with url: mark_low_quality_admin_low_quality_dashboard_index_path, method: :post, local: true do |form| %>
                        <%= form.hidden_field :project_id, value: project.id %>
                        <div style="margin-bottom: 12px;">
                          <label style="display: block; color: #E4DCC6; font-size: 12px; margin-bottom: 4px; text-transform: uppercase;">Reason required:</label>
                          <%= form.text_area :reason,
                              placeholder: "Explain why this project doesn't meet quality standards...",
                              required: true,
                              style: "width: 100%; min-height: 90px; padding: 10px; background: transparent; border: 1px solid #E4DCC6; color: #ffffff; border-radius: 0; resize: vertical;" %>
                        </div>
                        <%= form.submit "Confirm Low Quality",
                            style: "background: #e74c3c; color: white; border: none; padding: 10px 18px; cursor: pointer; border-radius: 0; font-weight: 700;" %>
                      <% end %>
                    </div>
                  </details>
                  <details>
                    <summary style="color: #E4DCC6; cursor: pointer; font-size: 13px; background: #27ae60; color: white; padding: 10px 14px; border-radius: 0;">Mark OK</summary>
                    <div style="margin-top: 8px; padding: 12px; background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 0;">
                      <%= form_with url: mark_ok_admin_low_quality_dashboard_index_path, method: :post, local: true do |form| %>
                        <%= form.hidden_field :project_id, value: project.id %>
                        <div style="margin-bottom: 12px;">
                          <label style="display: block; color: #E4DCC6; font-size: 12px; margin-bottom: 4px; text-transform: uppercase;">Optional justification:</label>
                          <%= form.text_field :ok_reason, placeholder: "Why is this OK?", style: "width: 100%; padding: 10px; background: transparent; border: 1px solid #E4DCC6; color: #ffffff; border-radius: 0;" %>
                        </div>
                        <%= form.submit "Mark OK",
                            style: "background: #27ae60; color: white; border: none; padding: 10px 18px; cursor: pointer; border-radius: 0; font-weight: 700;" %>
                      <% end %>
                    </div>
                  </details>
                </div>
              <% else %>
                <% resolved_report = (@project_reports[project.id] || []).find(&:resolved?) %>
                <% if resolved_report %>
                  <% missing_metadata = resolved_report.resolver.nil? || resolved_report.resolved_outcome.blank? %>
                  <div style="color: #E4DCC6; font-size: 12px;">
                    <strong>Resolved</strong> <%= time_ago_in_words(resolved_report.resolved_at || Time.current) %> ago
                    <% if missing_metadata %>
                      <br>
                      <span>Handled before migration — resolver/outcome not tracked.</span>
                    <% else %>
                      by <%= resolved_report.resolver&.display_name || resolved_report.resolver&.email || "Unknown" %><br>
                      Outcome: <%= resolved_report.resolved_outcome == 'low_quality' ? 'Marked low-quality' : 'Marked OK' %>
                    <% end %>
                  </div>
                  <% unless missing_metadata %>
                    <% if resolved_report.resolved_outcome == 'low_quality' %>
                      <details style="margin-top: 6px;">
                        <summary style="color: #E4DCC6; cursor: pointer; font-size: 12px;">View DM to user</summary>
                        <div style="margin-top: 6px; padding: 8px; background: rgba(228, 220, 198, 0.08); border-left: 2px solid #E4DCC6; color: #ffffff; font-size: 13px;">
                          <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">
                          <%= resolved_report.resolved_message.to_s %>
                          </pre>
                        </div>
                      </details>
                    <% else %>
                      <div style="margin-top: 6px; color: #E4DCC6; font-size: 12px;">No DM sent; marked OK<% if resolved_report.resolved_message.present? %> — Note: <%= resolved_report.resolved_message %><% end %></div>
                    <% end %>
                  <% end %>
                <% else %>
                  <span style="color: #E4DCC6;">Resolved</span>
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
</div>

<style>
  table {
    width: 100%;
    border-collapse: collapse;
    background: transparent;
    border: 2px solid #E4DCC6;
    border-radius: 0;
  }
  th, td {
    padding: 16px 12px;
    text-align: left;
    border-bottom: 1px solid #E4DCC6;
    color: #ffffff;
    vertical-align: top;
  }
  thead th {
    background: transparent;
    color: #E4DCC6;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
  }
  tbody tr:hover {
    background: rgba(228, 220, 198, 0.05);
  }
  details summary {
    list-style: none;
  }
  details summary::-webkit-details-marker {
    display: none;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var toggleButton = document.getElementById('toggle-analytics');
  var analyticsSection = document.getElementById('analytics-section');

  toggleButton.addEventListener('click', function() {
    if (analyticsSection.style.display === 'none' || analyticsSection.style.display === '') {
      analyticsSection.style.display = 'block';
      toggleButton.textContent = 'Hide Analytics';
      toggleButton.classList.remove('pill-blue');
      toggleButton.classList.add('pill-gray');
    } else {
      analyticsSection.style.display = 'none';
      toggleButton.textContent = 'Show Analytics';
      toggleButton.classList.remove('pill-gray');
      toggleButton.classList.add('pill-blue');
    }
  });
});
</script>

</body>

<div class="px-4 md:px-8">
  <!-- Music Button -->
  <button id="music-toggle" class="fixed top-4 md:top-8 md:right-6 right-18 z-50 w-12 h-12 text-white rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110" style="background: linear-gradient(135deg, #8b6f47 0%, #a0845c 50%, #8b6f47 100%); border: 2px solid #6b5439; box-shadow: 0 2px 4px rgba(107, 84, 57, 0.3);" title="Toggle Music">
    <span id="music-icon" class="text-lg leading-none cursor-pointer" style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%;">‚ô™</span>
  </button>
  <audio id="shop-music" loop preload="auto">
    <source src="<%= asset_path('the_stash.mp3') %>" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <%= render "shared/page_title",
    title: "#{current_user ? '' : 'Summer of Making '}Shop",
    subtitle: "What catches your eye?" %>
    <div class="fixed top-4 right-28 z-50">
      <% admin_tool("mb-4") do %>
        <p><%= @shop_items.count %> items - <%= link_to "edit them?", admin_shop_items_path, class: "underline" %></p>
      <% end %>
    </div>

  <% if current_user && current_verification_status != :verified %>
    <div class="flex justify-center mb-4">
      <%= render "verification_callout" %>
    </div>
  <% end %>

  <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <% if current_user&.shop_orders&.any? %>
        <%= render C::StyledButton.new(
          text: "View My Orders",
          link: shop_orders_path,
          kind: :primary,
          fill_width: false,
          icon: nil) %>
      <% end %>

      <% if @regionalization_enabled %>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-[#3a2f25]">üåç Region:</span>
          <select id="region-selector" class="px-3 py-2 border-2 border-[#8b6f47] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8b6f47] focus:border-transparent text-sm">
            <% Shop::Regionalizable::REGIONS.each do |code, config| %>
              <option value="<%= code %>" <%= 'selected' if @selected_region == code %>>
                <%= config[:name] %>
              </option>
            <% end %>
          </select>
        </div>
      <% end %>
    </div>
  </div>

  <%
     items = (@regular_items + @badge_items).select(&:show_in_carousel)
     sales = items.select(&:on_sale?)
     regulars = items.reject(&:on_sale?)
     sales.sort_by! { |item| -item.sale_percentage.to_i }
     f = sales + regulars.shuffle
  %>
  <% if f.any? %>
    <div class="mb-8">
        <div class="text-center mb-4">
          <h2 class="text-xl font-bold text-[#3a2f25] font-['DynaPuff',sans-serif] mb-1">Featured Items</h2>
          <p class="text-sm text-[#666] font-['National Park',sans-serif]">not sure what to get? what about these?</p>
        </div>
        <div class="coolshits-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
          <% f.take(2).each_with_index do |item, index| %>
            <div class="coolshit block sm:hidden">
              <%= render partial: "item", locals: { item: item, item_data: item.item_data, minimal: true } %>
            </div>
          <% end %>
          <% f.take(3).each_with_index do |item, index| %>
            <div class="coolshit hidden sm:block md:hidden">
              <%= render partial: "item", locals: { item: item, item_data: item.item_data, minimal: true } %>
            </div>
          <% end %>
          <% f.take(4).each_with_index do |item, index| %>
            <div class="coolshit hidden md:block lg:hidden">
              <%= render partial: "item", locals: { item: item, item_data: item.item_data, minimal: true } %>
            </div>
          <% end %>
          <% f.take(5).each_with_index do |item, index| %>
            <div class="coolshit hidden lg:block xl:hidden">
              <%= render partial: "item", locals: { item: item, item_data: item.item_data, minimal: true } %>
            </div>
          <% end %>
          <% f.take(6).each_with_index do |item, index| %>
            <div class="coolshit hidden xl:block">
              <%= render partial: "item", locals: { item: item, item_data: item.item_data, minimal: true } %>
            </div>
          <% end %>
        </div>
    </div>
  <% end %>

  <% unless current_user %>
    <div id="how-it-works" class="mt-15">
      <div class="relative mb-8 md:mb-16 flex flex-col items-center">
        <div class="relative flex flex-col md:flex-row gap-4 md:gap-8 mx-auto justify-center items-center md:items-stretch">
          <%= render C::Card.new(css_classes: 'h-full max-w-96 sm:max-w-lg md:max-w-80 lg:max-w-96 animate-wave') do %>
            <div class="p-4 md:p-5 relative text-center">
              <h3 class="text-xl md:text-2xl font-bold mb-3 md:mb-4 text-[#3a2f25] font-['DynaPuff',sans-serif]">Build
                Stuff</h3>
              <p class="font-['Fredoka',sans-serif] font-normal text-base md:text-lg text-[#3a2f25]">
                Build websites, games, apps, or any other personal open-source coding projects to showcase your skills
                and earn precious
                <span class="italic">
                  shells
                  <picture class="inline-block mx-1 mb-1 w-5 h-5">
                    <source srcset="/shell.avif" type="image/avif">
                    <source srcset="/shell.webp" type="image/webp">
                    <img src="/shell.png" class="inline-block mx-1 mb-1 w-5 h-5" alt="shell" loading="lazy">
                  </picture>
                </span>
              </p>
            </div>
          <% end %>

          <%= render C::Card.new(css_classes: 'h-full max-w-96 sm:max-w-lg md:max-w-80 lg:max-w-96 animate-wave-offset') do %>
            <div class="p-4 md:p-5 relative text-center">
              <h3 class="text-xl md:text-2xl font-bold mb-3 md:mb-4 text-[#3a2f25] font-['DynaPuff',sans-serif]">Get
                Stuff</h3>
              <p class="font-['Fredoka',sans-serif] font-normal text-base md:text-lg text-[#3a2f25]">
                Redeem your
                <span class="">shells
                  <picture class="inline-block mx-1 mb-1 w-5 h-5">
                  <source srcset="/shell.avif" type="image/avif">
                  <source srcset="/shell.webp" type="image/webp">
                  <img src="/shell.png" class="inline-block mx-1 mb-1 w-5 h-5" alt="shell" loading="lazy">
                </picture>
                for
                prizes! <br><br> You can see what's available so far below...
              </p>
            </div>
          <% end %>

          <div class="absolute mx-auto md:hidden block left-0">
            <img src="/arc_arrow_top_bottom.png" class="relative max-h-40 sm:max-h-48 -left-4 sm:-left-16 aspect-auto rotate-180" alt="arrow" loading="lazy">
          </div>

          <div class="absolute mx-auto md:hidden block right-0">
            <img src="/arc_arrow_top_bottom.png" class="relative max-h-40 sm:max-h-48 -right-4 sm:-right-16 aspect-auto" alt="arrow" loading="lazy">
          </div>

          <div class="absolute mx-auto -top-8 hidden md:block">
            <img src="/arc_arrow_left_right.png" class="max-w-48 aspect-auto" alt="arrow" loading="lazy">
          </div>

          <div class="absolute mx-auto -bottom-8 hidden md:block">
            <img src="/arc_arrow_left_right.png" class="max-w-48 aspect-auto rotate-180" alt="arrow" loading="lazy">
          </div>
        </div>
      </div>
      <%#= render "example_project" %>
    </div>
  <% end %>
  <div class="my-6 text-center flex justify-center flex-col">
    <div class="text-center mb-4">
      <h2 class="text-xl font-bold text-[#3a2f25] font-['DynaPuff',sans-serif] mb-1">All Items</h2>
      <p class="text-sm text-[#666] font-['National Park',sans-serif]">options? we got em</p>
    </div>
    <% if @shop_items.empty? || (Flipper.enabled?(:enable_shop_balloons, current_user) && @shop_items.count == 1 && @shop_items.first.is_a?(ShopItem::SinkeningBalloons) && (!current_user&.sinkening_participation? || @ordered_once_item_ids&.include?(@shop_items.first.id))) %>
      <%= render C::Card.new(css_classes: 'max-w-md mx-auto') do %>
        <div class="text-lg font-semibold text-[#3a2f25] font-['DynaPuff',sans-serif] mb-1">
          <% if @regionalization_enabled %>
            üö´ No items available in <%= Shop::Regionalizable.region_name(@selected_region) %>
          <% else %>
            üö´ No items available
          <% end %>
        </div>
        <p class="text-sm text-[#666] font-['National Park',sans-serif] mb-2">
          <% if @regionalization_enabled %>
            None of our shop items are currently enabled for your region. Try selecting a different region or check back later!
          <% else %>
            No shop items are currently available. Check back later!
          <% end %>
        </p>
        <% if @regionalization_enabled %>
          <button onclick="document.getElementById('region-selector').focus()" class="bg-som-orange hover:bg-[#d55a35] text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
            Change Region
          </button>
        <% end %>
      <% end %>
    <% else %>
      <% if @regular_items.any? %>
        <div class="mb-6">
          <div class="flex flex-col sm:grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <% if cookies[:dismissed_raffle_v3] != 'true' && current_user&.tutorial_completed? %>
              <%= render partial: "raffle_card" %>
            <% end %>
            <% @regular_items.each do |item| %>
              <% if item.is_a?(ShopItem::SinkeningBalloons) %>
                <% if Flipper.enabled?(:enable_shop_balloons, current_user) && current_user&.sinkening_participation? && !@ordered_once_item_ids.include?(item.id) %>
                  <%= render partial: "item", locals: { item: item, item_data: item.item_data } %>
                <% end %>
              <% else %>
                <%= render partial: "item", locals: { item: item, item_data: item.item_data } %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Badge Items Section -->
      <% if @badge_items.any? %>
        <div class="mb-6">
          <%= render C::Card.new(css_classes: 'max-w-5xl mx-auto mb-4', padding: 'md') do %>
            <div class="text-center">
              <h2 class="text-2xl font-bold text-[#3a2f25] font-['DynaPuff',sans-serif] mb-1">üèÜ Badge Collection</h2>
              <p class="text-base text-[#666] font-['National Park',sans-serif]">buy glory! buy fame! buy power.</p>
            </div>
          <% end %>
          <div class="flex flex-col sm:grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <% @badge_items.each do |item| %>
              <%= render partial: "item", locals: { item: item, item_data: item.item_data } %>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if current_user&.has_black_market? %>
        <div class="bg-black p-4 mt-12 text-3xl" style="transform:rotate(-4deg);max-width:fit-content;align-self:center;">
          <h1 class="text-white text-2xl underline font-serif">
            <%= link_to "visit the black market", black_market_path, class: "text-white" %>
          </h1>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<% unless current_user %>
  <div class="my-6 text-center flex justify-center flex-col">
    <div class="max-w-2xl mx-auto">
      <h2 class="text-3xl md:text-4xl font-bold mb-4 text-[#3a2f25] font-['DynaPuff',sans-serif]">Sound good?</h2>
      <p class="text-lg md:text-xl mb-6 font-['Fredoka',sans-serif] text-[#3a2f25]">You could have it
        all...</p> <!--my empire of dirt-->
      <%= link_to root_path, class: "inline-block px-8 py-4 bg-som-orange hover:bg-[#d55a35] text-white font-bold text-xl rounded-lg transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" do %>
        Go build something awesome this summer ‚Üí
      <% end %>
    </div>
  </div>
<% end %>

<style>
  .coolshit {
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const musicToggle = document.getElementById('music-toggle');
    const musicIcon = document.getElementById('music-icon');
    const shopMusic = document.getElementById('shop-music');
    let isPlaying = false;

    musicToggle.addEventListener('click', function () {
      if (isPlaying) {
        shopMusic.pause();
        shopMusic.muted = true;
        musicIcon.textContent = '‚ô´';
        musicToggle.title = 'Play Music';
        isPlaying = false;
      } else {
        shopMusic.muted = false;
        shopMusic.play().catch(function (error) {
          console.log('Audio play failed:', error);
        });
        musicIcon.textContent = 'üîá';
        musicToggle.title = 'Mute Music';
        isPlaying = true;
      }
    });

    // Region selector (only if regionalization is enabled)
    const regionSelector = document.getElementById('region-selector');
    if (regionSelector) {
      regionSelector.addEventListener('change', function() {
        const selectedRegion = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('region', selectedRegion);

        // Show loading state
        regionSelector.disabled = true;
        regionSelector.style.opacity = '0.6';

        window.location.href = currentUrl.toString();
      });
    }
    const fi = document.querySelectorAll('.coolshit [data-item-id]');
    fi.forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();

        const id = this.getAttribute('data-item-id');
        if (id) {
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = '';
          }, 150);

          window.location.hash = `item-${id}`;
          const t = document.getElementById(`item-${id}`);
          if (t) {
            t.classList.add('ring', 'ring-4', 'ring-yellow-400');
            setTimeout(() => {
              t.classList.remove('ring', 'ring-4', 'ring-yellow-400');
            }, 2000);
          }
        }
      });
    });
  });
</script>

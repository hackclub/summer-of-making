<%# Use pre-computed data %>
<% regional_price = item_data[:regional_price] %>
<% remaining = item_data[:remaining_stock] %>
<% out_of_stock = item_data[:out_of_stock] %>
<% already_ordered = item_data[:already_ordered] %>
<% minimal = local_assigns.fetch(:minimal, false) %>
<% if current_user %>
  <% ineligible = @current_verification_status == :ineligible %>
  <% if item.is_a?(ShopItem::BadgeItem) %>
    <% badge_key = item.internal_description&.to_sym %>
    <% badge_prerequisite_failed = (badge_key == :gold_verified && !@user_badge_keys&.include?(:verified)) || (@user_badge_keys && badge_key && @user_badge_keys.include?(badge_key)) %>
  <% else %>
    <% badge_prerequisite_failed = false %>
  <% end %>
  <% disabled = ineligible || (!@current_user_ysws_verified && !item.is_a?(ShopItem::FreeStickers)) || (@current_balance < regional_price) || out_of_stock || badge_prerequisite_failed %>
<% end %>
<div id="<%= minimal ? "featured-item-#{item.id}" : "item-#{item.id}" %>">
<% if minimal %>
  <div class="cursor-pointer transition-transform hover:scale-105" data-item-id="<%= item.id %>">
    <%= render C::Card.new(css_classes: "h-full", padding: "sm") do %>
      <div class="flex flex-col h-full relative">
        <% if item.on_sale? %>
          <div class="absolute top-0 left-0 z-10 sale-ribbon text-white text-xs font-bold px-1 py-0.5">
            <%= item.sale_percentage %>% OFF!
          </div>
        <% end %>
        <div class="flex-shrink-0 mb-2">
          <% if item.image.attached? %>
        <div class="mb-4 flex justify-center flex-shrink-0">
          <%= image_tag item.image.variant(:thumb), class: "rounded-lg w-full h-auto object-scale-down aspect-square max-h-48" %>
        </div>
      <% end %>
        </div>
        <div class="flex-1 text-center">
          <h3 class="text-xs font-semibold text-[#3a2f25] mb-1 line-clamp-2 font-['DynaPuff',sans-serif]">
            <%= item.name %>
          </h3>
          <% if item.on_sale? %>
            <% o = (@regionalization_enabled && @selected_region) ?
                 (item.ticket_cost + (item.send("price_offset_#{@selected_region.downcase}") || 0)) :
                 item.ticket_cost %>
            <div class="relative flex items-center justify-center">
              <div class="flex items-center gap-1 text-xs text-gray-400 line-through opacity-75">
                <picture class="inline-block w-3 h-3">
                  <source srcset="/shell.avif" type="image/avif">
                  <source srcset="/shell.webp" type="image/webp">
                  <img src="/shell.png" class="w-3 h-3" alt="shell" loading="lazy">
                </picture>
                <span><%= o.round %></span>
              </div>
              <div class="absolute top-0 left-1/2 transform translate-x-1/2 flex items-center gap-1 text-sm font-black text-red-600">
                <picture class="inline-block w-4 h-4">
                  <source srcset="/shell.avif" type="image/avif">
                  <source srcset="/shell.webp" type="image/webp">
                  <img src="/shell.png" class="w-4 h-4" alt="shell" loading="lazy">
                </picture>
                <span><%= regional_price.round %></span>
              </div>
            </div>
          <% else %>
            <div class="flex items-center justify-center gap-1">
              <picture class="inline-block w-3 h-3">
                <source srcset="/shell.avif" type="image/avif">
                <source srcset="/shell.webp" type="image/webp">
                <img src="/shell.png" class="w-3 h-3" alt="shell" loading="lazy">
              </picture>
              <span class="text-xs font-bold text-[#8b6f47]">
                <%= regional_price.round %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
<%= render C::Card.new(css_classes: "h-full #{"col-span-full" if item.is_free?}") do %>
  <div class="flex flex-col relative flex-1">
    <% if item.on_sale? %>
      <div class="absolute top-0 left-0 z-10 sale-ribbon text-white text-xs font-bold px-2 py-1">
        <%= item.sale_percentage %>% OFF!
      </div>
    <% end %>
    <% admin_tool do %>
      <div class="">
        <%= link_to "cfg", admin_shop_item_path(item), class: "underline text-sm", target: "_blank" %>
      </div>
    <% end %>
    <% if regional_price && regional_price > 0 %>
      <div class="absolute top-2 right-2 text-lg font-bold whitespace-nowrap flex items-center">
        <% if item.on_sale? %>
          <% o = (@regionalization_enabled && @selected_region) ?
               (item.ticket_cost + (item.send("price_offset_#{@selected_region.downcase}") || 0)) :
               item.ticket_cost %>
          <div class="relative mr-2">
            <div class="flex items-center text-lg font-bold text-gray-400 line-through opacity-75">
              <picture class="inline-block w-5 h-5 mr-2">
                <source srcset="/shell.avif" type="image/avif">
                <source srcset="/shell.webp" type="image/webp">
                <img src="/shell.png" class="w-5 h-5" alt="shell" loading="lazy">
              </picture>
              <%= o.round %>
            </div>
            <div class="absolute top-0 left-0 flex items-center text-2xl font-black text-red-600">
              <picture class="inline-block w-6 h-6 mr-2">
                <source srcset="/shell.avif" type="image/avif">
                <source srcset="/shell.webp" type="image/webp">
                <img src="/shell.png" class="w-6 h-6" alt="shell" loading="lazy">
              </picture>
              <%= regional_price.round %>
            </div>
          </div>
        <% else %>
          <picture class="inline-block mx-1 mb-2 w-5 h-5 mr-2">
            <source srcset="/shell.avif" type="image/avif">
            <source srcset="/shell.webp" type="image/webp">
            <img src="/shell.png" class="inline-block mx-1 mb-1 w-5 h-5" alt="shell" loading="lazy">
          </picture>
          <%= regional_price.round %>
        <% end %>
      </div>
    <% end %>
    <div class="flex-1 flex flex-col">
      <h3 class="text-xl font-bold mb-2"><%= item.name %></h3>
      <div class="mb-4">
        <p class="text-gray-700"><%== item.description %></p>
        <%# erb_lint:disable ErbSafety %>
        <% if item.limited? %>
          <% if remaining && remaining > 0 %>
            <p class="text-sm text-orange-600 font-semibold mt-2">
              <%= remaining %> left
            </p>
          <% elsif remaining && remaining <= 0 %>
            <p class="text-sm text-red-600 font-semibold mt-2">
              Out of Stock
            </p>
          <% end %>
        <% end %>
      </div>
      <% if item.image.attached? %>
        <div class="mb-4 flex justify-center flex-shrink-0">
          <%= image_tag item.image.variant(:thumb), class: "rounded-lg w-full h-auto object-scale-down aspect-square max-h-48" %>
        </div>
      <% end %>
      <div class="flex-grow"></div>
    </div>
    <div class="flex-shrink-0 flex flex-col gap-2">
      <% if current_user %>
        <div class="">
          <% if already_ordered %>
            <%= render C::StyledButton.new(
                text: "Already Ordered",
                kind: :buy,
                fill_width: true,
                disabled: true) %>
          <% else %>
            <% user_balance = @current_balance %>
            <% button_text = if out_of_stock
                              "Out of Stock"
                            elsif ineligible
                              "Not for you!"
                            elsif item.is_a?(ShopItem::BadgeItem) && !item.can_purchase?(current_user)
                              item.prereq(current_user)
                            elsif !@current_user_ysws_verified && !item.is_a?(ShopItem::FreeStickers)
                              "Get your ID verified first!"
                            elsif user_balance >= regional_price
                              if item.is_a?(ShopItem::FreeStickers)
                                "Verify ID to acquire!"
                              elsif regional_price == 0
                                "Acquire!"
                              else
                                "Buy for #{render_shells(regional_price)} shells!"
                              end
                            else
                              "#{render_shells(regional_price - user_balance)} more shells needed"
                            end %>
            <%= form_with url: order_shop_item_path(item), method: :get, data: { turbo: false }, local: true, class: "w-full" do |form| %>
              <%= render C::StyledButton.new(
                  text: button_text,
                  kind: :buy,
                  fill_width: true,
                  disabled: disabled,
                  type: :submit) %>
            <% end %>
          <% end %>
        </div>
      <% end %>
      <% unless item.is_free? %>
        <% hours = item.fixed_estimate(regional_price).round %>
        <div class="text-xs text-gray-500 text-center">
          â‰ˆ<%= hours %> <%= "hour".pluralize(hours) %> on an average project
        </div>
      <% else %>
        <div class="text-xs text-gray-500 text-center">
          This item is free! Go for it!
        </div>
      <% end %>
    </div>
  </div>
<% end %>
<% end %>
</div>
<!-- <script>
document.addEventListener('DOMContentLoaded', () => {
  for (const itemContainer of document.querySelectorAll(".item-container")) {
    const item = itemContainer.querySelector(".item")
    const form = itemContainer.querySelector("form")

    form.style.display = "none";

    item.querySelector("button.edit").onclick = () => {
      item.style.display = "none";
      form.style.display = "block"
    }

    form.onsubmit = (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      fetch("<%= shop_item_path(item.id) %>", {
        method: 'PATCH',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(res => {
        // if (res.ok)
        location.reload()
      })
    }
  }
})
</script> -->
